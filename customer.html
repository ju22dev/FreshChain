<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üåø FreshChain Customer</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.6.0/dist/ethers.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        .card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            margin-bottom: 20px;
        }

        .header {
            background: linear-gradient(135deg, #43cea2 0%, #185a9d 100%);
            color: white;
            padding: 24px;
            text-align: center;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .section {
            padding: 20px;
            border-bottom: 1px solid #eee;
        }

        .section:last-child {
            border-bottom: none;
        }

        .section-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            color: #667eea;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #f5f5f5;
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .info-label {
            font-weight: 500;
            color: #666;
            font-size: 14px;
        }

        .info-value {
            font-weight: 500;
            color: #333;
            font-size: 14px;
            text-align: right;
            word-break: break-all;
            max-width: 60%;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
        }

        .badge-danger {
            background: #f8d7da;
            color: #721c24;
        }

        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }

        .badge-info {
            background: #d1ecf1;
            color: #0c5460;
        }

        .reading-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .reading-card:last-child {
            margin-bottom: 0;
        }

        .reading-header {
            font-weight: 600;
            margin-bottom: 8px;
            color: #667eea;
        }

        .reading-details {
            font-size: 13px;
            color: #666;
            line-height: 1.6;
        }

        .history-item {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .history-item:last-child {
            margin-bottom: 0;
        }

        .history-action {
            font-weight: 600;
            color: #667eea;
            margin-bottom: 4px;
        }

        .history-details {
            font-size: 13px;
            color: #666;
            margin-bottom: 8px;
        }

        .history-meta {
            font-size: 12px;
            color: #999;
        }

        .loading, .error {
            text-align: center;
            padding: 40px 20px;
        }

        .loading {
            color: white;
            font-size: 18px;
        }

        .error {
            background: white;
            border-radius: 16px;
            color: #721c24;
        }

        .error h2 {
            margin-bottom: 12px;
            color: #721c24;
        }

        .footer {
            text-align: center;
            padding: 20px;
            color: white;
            font-size: 12px;
            opacity: 0.8;
        }

        .address {
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>

<body>
    <div class="container">
        <div id="content"></div>
    </div>

    <script>
        const CONTRACT_ADDRESS = "0x50e31814E55e1ae19F7C0b2c1f5276f109Ed55BE";
        const RPC = "https://eth-sepolia.g.alchemy.com/v2/iZf1PfPx4JrG22mc06JQQ";
        const ABI = [
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "batchId",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "bool",
				"name": "passedInspection",
				"type": "bool"
			}
		],
		"name": "BatchArrived",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "batchId",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "string",
				"name": "productName",
				"type": "string"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "quantity",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "address",
				"name": "producer",
				"type": "address"
			}
		],
		"name": "BatchCreated",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "address",
				"name": "distributor",
				"type": "address"
			}
		],
		"name": "DistributorRegistered",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "batchId",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "address",
				"name": "from",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "address",
				"name": "to",
				"type": "address"
			}
		],
		"name": "OwnershipTransferred",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "address",
				"name": "producer",
				"type": "address"
			}
		],
		"name": "ProducerRegistered",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "address",
				"name": "retailer",
				"type": "address"
			}
		],
		"name": "RetailerRegistered",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "batchId",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "int256",
				"name": "temperature",
				"type": "int256"
			},
			{
				"indexed": false,
				"internalType": "int256",
				"name": "humidity",
				"type": "int256"
			},
			{
				"indexed": false,
				"internalType": "string",
				"name": "location",
				"type": "string"
			}
		],
		"name": "SensorDataAdded",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "address",
				"name": "transporter",
				"type": "address"
			}
		],
		"name": "TransporterRegistered",
		"type": "event"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "batchId",
				"type": "uint256"
			},
			{
				"internalType": "int256",
				"name": "temperature",
				"type": "int256"
			},
			{
				"internalType": "int256",
				"name": "humidity",
				"type": "int256"
			},
			{
				"internalType": "string",
				"name": "location",
				"type": "string"
			}
		],
		"name": "addSensorData",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "batchId",
				"type": "uint256"
			},
			{
				"internalType": "string",
				"name": "productName",
				"type": "string"
			},
			{
				"internalType": "uint256",
				"name": "quantity",
				"type": "uint256"
			}
		],
		"name": "createBatch",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "batchId",
				"type": "uint256"
			},
			{
				"internalType": "bool",
				"name": "passedInspection",
				"type": "bool"
			}
		],
		"name": "markAsArrived",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "distributor",
				"type": "address"
			}
		],
		"name": "registerDistributor",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "producer",
				"type": "address"
			}
		],
		"name": "registerProducer",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "retailer",
				"type": "address"
			}
		],
		"name": "registerRetailer",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "transporter",
				"type": "address"
			}
		],
		"name": "registerTransporter",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "batchId",
				"type": "uint256"
			},
			{
				"internalType": "address",
				"name": "newOwner",
				"type": "address"
			}
		],
		"name": "transferOwnership",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"stateMutability": "nonpayable",
		"type": "constructor"
	},
	{
		"inputs": [],
		"name": "getAllEntities",
		"outputs": [
			{
				"internalType": "address",
				"name": "theAdmin",
				"type": "address"
			},
			{
				"internalType": "address[]",
				"name": "allProducers",
				"type": "address[]"
			},
			{
				"internalType": "address[]",
				"name": "allTransporters",
				"type": "address[]"
			},
			{
				"internalType": "address[]",
				"name": "allDistributors",
				"type": "address[]"
			},
			{
				"internalType": "address[]",
				"name": "allRetailers",
				"type": "address[]"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "batchId",
				"type": "uint256"
			}
		],
		"name": "getBatch",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			},
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			},
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			},
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			},
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			},
			{
				"internalType": "enum FreshChain.BatchStatus",
				"name": "",
				"type": "uint8"
			},
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			},
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "batchId",
				"type": "uint256"
			}
		],
		"name": "getBatchHistory",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "id",
				"type": "uint256"
			},
			{
				"internalType": "string",
				"name": "productName",
				"type": "string"
			},
			{
				"internalType": "uint256",
				"name": "quantity",
				"type": "uint256"
			},
			{
				"internalType": "address",
				"name": "currentOwner",
				"type": "address"
			},
			{
				"internalType": "address",
				"name": "producer",
				"type": "address"
			},
			{
				"internalType": "enum FreshChain.BatchStatus",
				"name": "status",
				"type": "uint8"
			},
			{
				"internalType": "bool",
				"name": "passedInspection",
				"type": "bool"
			},
			{
				"internalType": "uint256",
				"name": "createdAt",
				"type": "uint256"
			},
			{
				"components": [
					{
						"internalType": "int256",
						"name": "temperature",
						"type": "int256"
					},
					{
						"internalType": "int256",
						"name": "humidity",
						"type": "int256"
					},
					{
						"internalType": "string",
						"name": "location",
						"type": "string"
					},
					{
						"internalType": "uint256",
						"name": "timestamp",
						"type": "uint256"
					},
					{
						"internalType": "address",
						"name": "recordedBy",
						"type": "address"
					}
				],
				"internalType": "struct FreshChain.SensorReading[]",
				"name": "sensorReadings",
				"type": "tuple[]"
			},
			{
				"components": [
					{
						"internalType": "string",
						"name": "action",
						"type": "string"
					},
					{
						"internalType": "address",
						"name": "actor",
						"type": "address"
					},
					{
						"internalType": "uint256",
						"name": "timestamp",
						"type": "uint256"
					},
					{
						"internalType": "string",
						"name": "details",
						"type": "string"
					}
				],
				"internalType": "struct FreshChain.History[]",
				"name": "historyLog",
				"type": "tuple[]"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "batchId",
				"type": "uint256"
			}
		],
		"name": "getSensorReadingCount",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "batchId",
				"type": "uint256"
			}
		],
		"name": "getSensorReadings",
		"outputs": [
			{
				"components": [
					{
						"internalType": "int256",
						"name": "temperature",
						"type": "int256"
					},
					{
						"internalType": "int256",
						"name": "humidity",
						"type": "int256"
					},
					{
						"internalType": "string",
						"name": "location",
						"type": "string"
					},
					{
						"internalType": "uint256",
						"name": "timestamp",
						"type": "uint256"
					},
					{
						"internalType": "address",
						"name": "recordedBy",
						"type": "address"
					}
				],
				"internalType": "struct FreshChain.SensorReading[]",
				"name": "",
				"type": "tuple[]"
			}
		],
		"stateMutability": "view",
		"type": "function"
	}
]; 

        const params = new URLSearchParams(location.search);
        const batchId = params.get("batchId");

        if (!batchId) {
            document.getElementById("content").innerHTML = `
                <div class="card error">
                    <h2>‚ùå No Batch ID Provided</h2>
                    <p>Please scan a QR code or add ?batchId=YOUR_BATCH_ID to the URL</p>
                </div>
            `;
        } else {
            load();
        }

        async function load() {
            const content = document.getElementById("content");
            content.innerHTML = '<div class="loading">‚è≥ Loading batch history...</div>';

            try {
                const provider = new ethers.JsonRpcProvider(RPC);
                const contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, provider);

                const batch = await contract.getBatchHistory(Number(batchId));
                console.log(batch);

                const statusNames = ['Created', 'InTransit', 'Arrived', 'Inspected'];
                const statusBadges = ['badge-info', 'badge-warning', 'badge-warning', 'badge-success'];

                let html = `
                    <div class="card">
                        <div class="header">
                            <h1>üåø FreshChain</h1>
                            <p>Product Journey & Verification</p>
                        </div>

                        <div class="section">
                            <div class="section-title">üì¶ Batch Information</div>
                            <div class="info-row">
                                <span class="info-label">Batch ID</span>
                                <span class="info-value">#${Number(batch[0])}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Product</span>
                                <span class="info-value">${batch.productName}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Quantity</span>
                                <span class="info-value">${Number(batch.quantity)} kg</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Status</span>
                                <span class="info-value">
                                    <span class="badge ${statusBadges[Number(batch.status)]}">${statusNames[Number(batch.status)]}</span>
                                </span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Inspection</span>
                                <span class="info-value">
                                    <span class="badge ${batch.passedInspection ? 'badge-success' : Number(batch.status) === 3 ? 'badge-danger' : 'badge-warning'}">
                                        ${batch.passedInspection ? '‚úÖ PASSED' : Number(batch.status) === 3 ? '‚ùå FAILED' : '‚è≥ Pending'}
                                    </span>
                                </span>
                            </div>
                        </div>

                        <div class="section">
                            <div class="section-title">üë• Ownership</div>
                            <div class="info-row">
                                <span class="info-label">Producer</span>
                                <span class="info-value address">${batch.producer.slice(0, 6)}...${batch.producer.slice(-4)}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Current Owner</span>
                                <span class="info-value address">${batch.currentOwner.slice(0, 6)}...${batch.currentOwner.slice(-4)}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Created</span>
                                <span class="info-value">${new Date(Number(batch.createdAt) * 1000).toLocaleString()}</span>
                            </div>
                        </div>
                `;

                // Sensor Readings
                const sensorReadings = batch.sensorReadings;
                html += `
                    <div class="section">
                        <div class="section-title">üå°Ô∏è Temperature & Humidity Logs</div>
                `;

                if (sensorReadings.length === 0) {
                    html += '<p style="color: #999; font-size: 14px;">No sensor readings recorded yet.</p>';
                } else {
                    for (let i = 0; i < sensorReadings.length; i++) {
                        const reading = sensorReadings[i];
                        html += `
                            <div class="reading-card">
                                <div class="reading-header">üìç Reading #${i + 1} - ${reading.location}</div>
                                <div class="reading-details">
                                    <strong>Temperature:</strong> ${Number(reading.temperature)}¬∞C<br>
                                    <strong>Humidity:</strong> ${Number(reading.humidity)}%<br>
                                    <strong>Time:</strong> ${new Date(Number(reading.timestamp) * 1000).toLocaleString()}<br>
                                    <strong>Recorded by:</strong> <span class="address">${reading.recordedBy.slice(0, 6)}...${reading.recordedBy.slice(-4)}</span>
                                </div>
                            </div>
                        `;
                    }
                }
                html += '</div>';

                // History Log
                const history = batch.historyLog;
                html += `
                    <div class="section">
                        <div class="section-title">üìú Complete History</div>
                `;

                if (history.length === 0) {
                    html += '<p style="color: #999; font-size: 14px;">No history recorded yet.</p>';
                } else {
                    for (let i = 0; i < history.length; i++) {
                        const item = history[i];
                        html += `
                            <div class="history-item">
                                <div class="history-action">${item.action}</div>
                                <div class="history-details">${item.details}</div>
                                <div class="history-meta">
                                    ${new Date(Number(item.timestamp) * 1000).toLocaleString()} ‚Ä¢ 
                                    <span class="address">${item.actor.slice(0, 6)}...${item.actor.slice(-4)}</span>
                                </div>
                            </div>
                        `;
                    }
                }
                html += '</div>';

                // Footer
                html += `
                        <div class="section" style="background: #f8f9fa;">
                            <div style="text-align: center; color: #666; font-size: 13px;">
                                <div style="margin-bottom: 8px;">‚úÖ Verified on Blockchain</div>
                                <div class="address">üîó ${CONTRACT_ADDRESS.slice(0, 10)}...${CONTRACT_ADDRESS.slice(-8)}</div>
                            </div>
                        </div>
                    </div>
                `;

                content.innerHTML = html;

            } catch (e) {
                content.innerHTML = `
                    <div class="card error">
                        <h2>‚ùå Error Loading Batch</h2>
                        <p style="margin: 12px 0;"><strong>Batch ID:</strong> ${batchId}</p>
                        <p style="margin: 12px 0;"><strong>Error:</strong> ${e.reason || e.message}</p>
                        <p style="margin-top: 20px; color: #666;">
                            Possible issues:<br>
                            ‚Ä¢ Batch ID does not exist<br>
                            ‚Ä¢ Network connection problem<br>
                            ‚Ä¢ Contract address is incorrect
                        </p>
                    </div>
                `;
                console.error("Full error:", e);
            }
        }
    </script>
</body>

</html>