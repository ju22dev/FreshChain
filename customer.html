<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸŒ¿ FreshChain Customer</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.6.0/dist/ethers.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <div class="card">
        <pre id="out"></pre>
    </div>

    <script>
        const CONTRACT_ADDRESS = "0xBB8dEF1C0aA665877a53bfc0d69F2DA8DcF5dd97";

        const RPC = "https://eth-sepolia.g.alchemy.com/v2/iZf1PfPx4JrG22mc06JQQ";
        const ABI = [
            { "inputs": [], "stateMutability": "nonpayable", "type": "constructor" },
            { "anonymous": false, "inputs": [{ "indexed": false, "internalType": "uint256", "name": "batchId", "type": "uint256" }, { "indexed": false, "internalType": "bool", "name": "passedInspection", "type": "bool" }], "name": "BatchArrived", "type": "event" },
            { "anonymous": false, "inputs": [{ "indexed": false, "internalType": "uint256", "name": "batchId", "type": "uint256" }, { "indexed": false, "internalType": "string", "name": "productName", "type": "string" }, { "indexed": false, "internalType": "uint256", "name": "quantity", "type": "uint256" }, { "indexed": false, "internalType": "address", "name": "producer", "type": "address" }], "name": "BatchCreated", "type": "event" },
            { "anonymous": false, "inputs": [{ "indexed": false, "internalType": "address", "name": "distributor", "type": "address" }], "name": "DistributorRegistered", "type": "event" },
            { "anonymous": false, "inputs": [{ "indexed": false, "internalType": "uint256", "name": "batchId", "type": "uint256" }, { "indexed": false, "internalType": "address", "name": "from", "type": "address" }, { "indexed": false, "internalType": "address", "name": "to", "type": "address" }], "name": "OwnershipTransferred", "type": "event" },
            { "anonymous": false, "inputs": [{ "indexed": false, "internalType": "address", "name": "producer", "type": "address" }], "name": "ProducerRegistered", "type": "event" },
            { "anonymous": false, "inputs": [{ "indexed": false, "internalType": "address", "name": "retailer", "type": "address" }], "name": "RetailerRegistered", "type": "event" },
            { "anonymous": false, "inputs": [{ "indexed": false, "internalType": "uint256", "name": "batchId", "type": "uint256" }, { "indexed": false, "internalType": "int256", "name": "temperature", "type": "int256" }, { "indexed": false, "internalType": "int256", "name": "humidity", "type": "int256" }, { "indexed": false, "internalType": "string", "name": "location", "type": "string" }], "name": "SensorDataAdded", "type": "event" },
            { "anonymous": false, "inputs": [{ "indexed": false, "internalType": "address", "name": "transporter", "type": "address" }], "name": "TransporterRegistered", "type": "event" },
            { "inputs": [{ "internalType": "uint256", "name": "batchId", "type": "uint256" }, { "internalType": "int256", "name": "temperature", "type": "int256" }, { "internalType": "int256", "name": "humidity", "type": "int256" }, { "internalType": "string", "name": "location", "type": "string" }], "name": "addSensorData", "outputs": [], "stateMutability": "nonpayable", "type": "function" },
            { "inputs": [{ "internalType": "uint256", "name": "batchId", "type": "uint256" }, { "internalType": "string", "name": "productName", "type": "string" }, { "internalType": "uint256", "name": "quantity", "type": "uint256" }], "name": "createBatch", "outputs": [], "stateMutability": "nonpayable", "type": "function" },
            { "inputs": [{ "internalType": "uint256", "name": "batchId", "type": "uint256" }], "name": "getBatch", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }, { "internalType": "string", "name": "", "type": "string" }, { "internalType": "uint256", "name": "", "type": "uint256" }, { "internalType": "address", "name": "", "type": "address" }, { "internalType": "address", "name": "", "type": "address" }, { "internalType": "enum FreshChain.BatchStatus", "name": "", "type": "uint8" }, { "internalType": "bool", "name": "", "type": "bool" }, { "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" },
            { "inputs": [{ "internalType": "uint256", "name": "batchId", "type": "uint256" }], "name": "getBatchHistory", "outputs": [{ "internalType": "uint256", "name": "id", "type": "uint256" }, { "internalType": "string", "name": "productName", "type": "string" }, { "internalType": "uint256", "name": "quantity", "type": "uint256" }, { "internalType": "address", "name": "currentOwner", "type": "address" }, { "internalType": "address", "name": "producer", "type": "address" }, { "internalType": "enum FreshChain.BatchStatus", "name": "status", "type": "uint8" }, { "internalType": "bool", "name": "passedInspection", "type": "bool" }, { "internalType": "uint256", "name": "createdAt", "type": "uint256" }, { "components": [{ "internalType": "int256", "name": "temperature", "type": "int256" }, { "internalType": "int256", "name": "humidity", "type": "int256" }, { "internalType": "string", "name": "location", "type": "string" }, { "internalType": "uint256", "name": "timestamp", "type": "uint256" }, { "internalType": "address", "name": "recordedBy", "type": "address" }], "internalType": "struct FreshChain.SensorReading[]", "name": "sensorReadings", "type": "tuple[]" }], "stateMutability": "view", "type": "function" },
            { "inputs": [{ "internalType": "uint256", "name": "batchId", "type": "uint256" }], "name": "getSensorReadingCount", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" },
            { "inputs": [{ "internalType": "uint256", "name": "batchId", "type": "uint256" }], "name": "getSensorReadings", "outputs": [{ "components": [{ "internalType": "int256", "name": "temperature", "type": "int256" }, { "internalType": "int256", "name": "humidity", "type": "int256" }, { "internalType": "string", "name": "location", "type": "string" }, { "internalType": "uint256", "name": "timestamp", "type": "uint256" }, { "internalType": "address", "name": "recordedBy", "type": "address" }], "internalType": "struct FreshChain.SensorReading[]", "name": "", "type": "tuple[]" }], "stateMutability": "view", "type": "function" },
            { "inputs": [{ "internalType": "uint256", "name": "batchId", "type": "uint256" }, { "internalType": "bool", "name": "passedInspection", "type": "bool" }], "name": "markAsArrived", "outputs": [], "stateMutability": "nonpayable", "type": "function" },
            { "inputs": [{ "internalType": "address", "name": "distributor", "type": "address" }], "name": "registerDistributor", "outputs": [], "stateMutability": "nonpayable", "type": "function" },
            { "inputs": [{ "internalType": "address", "name": "producer", "type": "address" }], "name": "registerProducer", "outputs": [], "stateMutability": "nonpayable", "type": "function" },
            { "inputs": [{ "internalType": "address", "name": "retailer", "type": "address" }], "name": "registerRetailer", "outputs": [], "stateMutability": "nonpayable", "type": "function" },
            { "inputs": [{ "internalType": "address", "name": "transporter", "type": "address" }], "name": "registerTransporter", "outputs": [], "stateMutability": "nonpayable", "type": "function" },
            { "inputs": [{ "internalType": "uint256", "name": "batchId", "type": "uint256" }, { "internalType": "address", "name": "newOwner", "type": "address" }], "name": "transferOwnership", "outputs": [], "stateMutability": "nonpayable", "type": "function" }
        ];
        const params = new URLSearchParams(location.search);
        const batchId = params.get("batchId");

        if (!batchId) {
            out.innerText = "âŒ No batch ID provided.\n\nPlease scan a QR code or add ?batchId=YOUR_BATCH_ID to the URL";
        } else {
            load();
        }

        async function load() {
            try {
                out.innerText = "â³ Loading batch history...";

                const provider = new ethers.JsonRpcProvider(RPC);
                const contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, provider);

                const batch = await contract.getBatchHistory(Number(batchId));
                console.log(batch)
                const statusNames = ['Created', 'InTransit', 'Arrived', 'Inspected'];

                let txt = `
                    ğŸŒ¿ FRESHCHAIN - PRODUCT JOURNEY
                    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

                    ğŸ“¦ BATCH INFORMATION
                    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                    Batch ID: ${Number(batch[0])}
                    Product: ${batch.productName}
                    Quantity: ${Number(batch.quantity)} kg
                    Status: ${statusNames[Number(batch.status)]}
                    Inspection: ${batch.passedInspection ? 'âœ… PASSED' : Number(batch.status) === 3 ? 'âŒ FAILED' : 'â³ Pending'}

                    ğŸ‘¥ OWNERSHIP
                    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                    Producer: ${batch.producer}
                    Current Owner: ${batch.currentOwner}
                    Created: ${new Date(Number(batch.createdAt) * 1000)}

                    ğŸŒ¡ï¸ TEMPERATURE & HUMIDITY LOGS
                    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                `;

                const sensorReadings = Number(batch.sensorReadings);

                if (sensorReadings.length === 0) {
                    txt += "\nNo sensor readings recorded yet.\n";
                } else {
                    for (let i = 0; i < sensorReadings.length; i++) {
                        const reading = sensorReadings[i];
                        txt += `
                            ğŸ“ Reading #${i + 1}
                            â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                            Temperature: ${Number(reading.temperature)}Â°C
                            Humidity: ${Number(reading.humidity)}%
                            Location: ${reading.location}
                            Time: ${new Date(Number(reading.timestamp) * 1000)}
                            Recorded by: ${reading.recordedBy}
                        `;
                    }
                }

                txt += `
                    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    âœ… Verified on Blockchain
                    ğŸ”— Contract: ${CONTRACT_ADDRESS.slice(0, 6)}...${CONTRACT_ADDRESS.slice(-4)}
                `;

                out.innerText = txt;

            } catch (e) {
                out.innerText = `âŒ Error loading batch history

                    Error Details:
                    ${e.reason || e.message}

                    Possible issues:
                    - Batch ID ${batchId} does not exist
                    - Network connection problem

                    Please verify the batch ID and try again.`;
                console.error("Full error:", e);
            }
        }
    </script>
</body>

</html>